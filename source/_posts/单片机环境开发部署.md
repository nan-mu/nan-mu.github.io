---
title: 单片机环境开发部署
date: 2024-08-16 13:23:16
tags:
---

<!-- # 单片机环境开发部署 -->

在本门课的实践上我计划使用`esp32c3`作为开发板，使用`rust`作为编程语言。主要内容来自《The Rust on ESP Book》<https://docs.esp-rs.org/book/。由于在之前电信杯的报告中我已经描述了如何在`wsl`环境中配置环境，所以这里将记录`ubuntu`下的环境配置>

### 工作环境

ubuntu 22.04，如有必要：

```shell
sudo apt install llvm clang musl git curl vim pkg-config libssl-dev libudev-sys && udo apt-get install libudev-dev
```

## 编译后端

编写`rust`程序首先需要安装`rustup`，该工具能够帮助我们安装不同版本的`rust`编译环境。

```shell
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

使用`rust`进行嵌入式开发需要让项目处于`no_std`模式，这个模式下无法使用`std`库下的任何东西，一些必要功能是`unsafe`或者实验性的。这代表在编译器前端上需要选择`nightly`版本。但一般来讲我们暂时不需要关心这个问题，`rust`项目使用官方支持的现代化项目管理工具`cargo`管理这些为题，现在我们只需要下载一个专门为初学者准备的项目即可。为了下载项目模板，我们需要安装：

```shell
cargo install cargo-generate
```

该工具类似前端中的`vite`，它能够从多种方式构建项目并提供基础配置，使用以下命令下载我们所需的项目：

```shell
cargo generate esp-rs/esp-template
```

![image-20240310195235141](./%E5%8D%95%E7%89%87%E6%9C%BA%E7%8E%AF%E5%A2%83%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2.assets/image-20240310195235141.png)

在这里，我们配置了项目名称，这将在当前目录创建一个同名文件夹存放项目。然后是一些细节：

* 设置目标单片机，这里我们选择了单片机型号就指定了对应的交叉编译目标。`rust`使用`llvm`作为编译后端，这代便`rust`支持在所有`llvm`实现的硬件架构上编写程序（其中并不包含51系列）。描述这个编译目标使用一个三元组记录，分别为架构-操作系统-系统配置。例如在无操作系统情况下使用`esp32-c3`需要配置`riscv32imc-unknown-none-elf`，其分别代表32位的`riscv`架构，无操作系统，编译结果为`elf`文件。
* 设置高级模板项，选择`true`就有下面的设置项。
* 启用`wifi`，蓝牙和esp自有的通信功能。本质上是为项目添加了`esp-wifi`这个`crate`。`crate`是`rust`软件包的正式名称，但项目指定引入某一软件包时会将其源码下载到一个类似`node_modules`（当然这个地方不会搞得和黑洞一样重）。在项目编译时一起编译。
* 启用`esp`内存分配器，`rust`在`no_std`下编程时无法使用`std`库，这意味着一般情况下的一些动态数据结构等所有涉及内存分配的函数都无法使用。要使用这些就需要自己引入或实现一个全局分配器以使用`alloc`库。`std`库中的相关算法也是从这个库中借助操作系统实现。在这里我们将启用一个乐鑫官方编写的`alloctorer`库。
* 配置git相关，这个不重要。
* 使用 `Wokwi VS Code` 扩展来配置项目，以便支持 `Wokwi` 仿真。这是一个浏览器的仿真程序。但我没有实际使用过，从项目结构来看这似乎为项目配置了`Docket`容器相关。
* 配置`log crate`，这件为项目添加一个支持日志功能的`crate`。

现在我们暂时离开代码，将单片机连接到电脑。我购买的开发板是宙合开发的`esp32c3`（就是22年出的那个价格无感）。板载`usb`串口调试，所以直接连接就好，使用以下命令检查是否成功安装：

![image-20240310211623702](./%E5%8D%95%E7%89%87%E6%9C%BA%E7%8E%AF%E5%A2%83%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2.assets/image-20240310211623702.png)

在这之后我们就可以准备烧录程序了，由于板载串口和`esp32-c3`，我们可以不使用探针进行烧录，但还是缺一个上位机，使用以下命令安装：

```shell
cargo install espup
```

如软件名称所示，`espup`和`rustup`一样是一个用来安装工具链的工具。用以下命令安装剩余软件：

```shell
espup install && . ~/export-esp.sh # 该文件是设置环境变量，建议放置到.bashrc之类的地方
```

这一步需要非常好的网络环境。

> 在我实际验证中发现其实缺少了`espflash`，听名字就知道这是一个上位机程序。按理来说他会由`espup`安装，但我这里就是没有，所以手动安装以下：
>
> ```shell
> cargo install espflash
> ```
>
> 在这之后可能还会遇到权限问题。真正解决似乎涉及到对linux用户组的操作，具体细节我已经忘了，这里就简单粗暴地使用
>
> ```shell
> sudo chmod 666 /dev/{设备}
> ```

以上就是设置的全部流程，直接运行`cargo run`。即可，更多技术细节欢迎阅读我编写的电信杯报告书或者直接问我。

![image-20240310223957036](./%E5%8D%95%E7%89%87%E6%9C%BA%E7%8E%AF%E5%A2%83%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2.assets/image-20240310223957036.png)
