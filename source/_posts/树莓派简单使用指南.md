---
title: 树莓派简单使用指南
date: 2024-08-26 09:17:39
tags:
  - 嵌入式linux
  - aarch64
  - ubuntu
---

这篇文章的目的是为了让读者尽快掌握将树莓派部署到生产环境中的用法。以树莓派5和树莓派4b为例，前者使用`ubuntu 24 Noble`而后者使用`ubuntu 22 Jammy`。我将尽量照顾所有细节让初学者既明白如何操作也明白此种三昧。本教程假设工作在类`debian`发行版上。

## 烧录

一切的开始始于一次烧录。在这里，烧录的意思是在一个磁盘设备上创建很多分区，这些分区包含了我们需要的一切。得到这些你首先需要准备一个SD卡，一个读卡器。我们将要使用的SD卡将会被格式化所有内容所以请做好准备。

软件方面需要在树莓派官网下载最新版本的烧录器。目前树莓派官方开发的烧录器似乎刚到一岁，从开发周期来看还需要一些沉淀。所以最好每次开始烧录行为时都检查一下是否在使用最新的软件。一种方法是在树莓派的[官方网站[^1]][^1]找到下载链接。或者直接使用命令安装：

```bash
sudo apt install rpi-imager
```

无论以何种方式，我们现在都可以得到一个图形界面，像是这样：

![image-20240826100251610](image-20240826100251610.png)

我们开始操作前，请确保SD卡已经准备就绪。上面三个按钮是第一个坑，正确的设置流程必须重左往右点。第一个按钮选择树莓派型号，第二个按钮选择我们要安装的发行版。我们计划安装的`ubuntu`发行版在`Other general-purpose OS`。选择`ubuntu`然后下个页面有三个选项，分别是桌面版本，服务器版本和核心版本。我们选择中间的服务器版本。选择后窗体会退出，以便于我们点击最后一个按钮，之后进入具体的配置，点击右下的`NEXT`。

一般情况下你可能见到一个询问你是否使用自定义配置的页面，我们选择最左侧的编辑设置

![image-20240826102109525](image-20240826102109525.png)

设置的窗体如图所示，有三个标签页我们每一个都有关注。第一个是通用的一些设置：

* 设置主机名：这个适用于`mDNS`网络发现，最好开上。细节推荐阅读[这里[^2]][^2]
* 设置用户名和密码，这个简单。
  * 其中可以看到密码特别长，这是经过加密后的密码，是我上一次输的。我们可以不用动。
* 配置`WiFi`：这个相对重要，一开始假如树莓派无法接入显示屏的话需要连接一个可以显示`IP`的手机`WiFi`。当然最方便的就是这里直接准备好工作环境的`WiFi`（假如需要的话）
* 语言设置：没什么好说的

然后是第二页

![image-20240826104530606](image-20240826104530606.png)

这里主要设置`ssh`登陆相关，不建议设置第二项，因为我们可能会使用串口登陆。

第三页没什么可说的。

至此我们剩下的内容就是一路保存一路下一步。时硬件不同烧录过程可能会在半个小时左右完成。然后，我们就可以直接插到树莓派中使用了。

## 开机

插上SD卡，向typec口上插上电源，树莓派就开机了。我们的第一个任务是知道树莓派的`ip`地址，后很多中方法：

* 直接连接显示器和键盘，你会在命令行里登陆。登陆后输入`hostname -I`找到和你主机在同一网段的`ip`地址。
* 假如你使用的是可以查看连接设备ip地址的手机WiFi热点，那你已经知道了
* 使用网线链接，但这个我没有尝试过，我认为[这篇教程[^3]][^3]值得参考。
* 使用串口连接，这个我只在树莓派4B上成功过，需要硬件，[这篇教程[^4]][^4]值得参考。

有了`ip`地址之后我们就可以回到自己的`pc`上操作树莓派。一般，我们需要将树莓派视作生产环境，我们自己的设备或者服务器视作开发环境。两个环境需要隔离开，之后做好准备之后才将软件部署到生产环境当中。这是因为在生产环境中做开发很不安全。而我们就需要一个能够快速部署软件的方法。总之，我们要在自己开发用电脑上使用`openssh`。

```bash
# 形如ssh xxx@10.1.1.1
ssh <树莓派上用户名>@<树莓派的ip>
```

假如无法连接，大概率是没有选择正确的`ip`。使用`ping`命令检查我们的开发电脑能否连接树莓派

```bash
ping <树莓派的ip>
```

### 清理环境

正确连接之后还有几项工作。首先第一步是换源，我们需要将树莓派原本的`apt`软件镜像源更换为国内的快速镜像源，建议使用物理位置距离自己近的，这里以清华源为例。在这之前需要明确一个概念，在 `ubuntu` 中，软件源的名称中带有 `-ports`（如 `ports.ubuntu.com`）和不带 `-ports` 的区别通常与支持的硬件架构相关。而我们的树莓派的架构是`Cortex-A76`的`aarch64`，在清华源中应该使用[这个[^5]][^5]。似乎现在网上有些资料说只要是`aarch64`的架构，非`ports`就能用，但我实际测试下来并非如此，可能和清华源的规划有关？

第二个坑是软件源格式

![image-20240826133714960](image-20240826133714960.png)

图片中为清华帮你做好的两种镜像格式，传统格式的用法是将文本框内的所有东西写到`/etc/apt/sources.list`，`DEB822`格式也是将下面文本框内的所有东西写道`/etc/apt/sources.list.d/ubuntu.sources`。`.d`为后缀的文件夹意为拓展；比如这里的`sources.list.d`意思是`sources.list`的拓展。以前大家把所有东西都直接写到`sources.list`导致用户难以维护这个文件，所以就有了`DEB822`格式。**<u>注意，`DEB822`格式是`ubuntu 24`推荐的，所以建议只在树莓派5上使用它；在树莓派4B上使用传统格式最好。</u>**

这里还有一个小点，清华的软件源中有一个部分是`ubuntu`官方的安全补丁源。可以注释，因为他们有另一套机制管理安全补丁，这个后面再说。

第三个坑是`snap`。他是`ubuntu`官方在推的一个包管理器。技术上是将每一个软件直接放在一个容器当中。起到版本隔离的效果。实际上它的速度，体积，权限管理还有安全问题一直饱受社区诟病。不推荐在生产环境或是开发环境留着`snap`所以我们现在要做的就是删掉它。具体流程有一篇很好的[博文[^6]][^6]。我就不多赘述了。

然后是第四个坑，我们来处理网络问题。简单来说，`linux`中有很多配置网络的工具，比如`systemd`和`NetWorkManager`。提到这两个软件的原因是我没法在我自己叠树莓派5上同时使用他们。`NetWorkManager`有一个很好的`tui`程序叫`nmtui`。拿它来配置有线网无线网都很方便，配置静态`ip`和使用`dhcp`自动请求分配`ip`也很方便。

> `TUI`（Text-based User Interface）指的是基于文本的用户界面，这种界面在终端窗口中呈现，而不是使用图形界面（`GUI`）。`TUI` 是一种以文本为基础的界面，通常用于命令行界面（`CLI`）程序中，为用户提供一种交互方式，常见于 Linux 和 UNIX 系统中。

问题就是树莓派5不知道干了什么，导致自己的`raspberrypi OS`和自己改的`ubuntu 24`都无法使用`nmtui`。而根据我使用4B的经验，它们使用的`systemd`的工具链。其实这种方法很适合静态`ip`，只用写一些配置文件我们甚至不用启动机器就能完成网络的配置。可惜问题处在`dhcp`自动分配`ip`上。这里还是推荐一篇[教程[^7]][^7]。

其实网络的优先级需要高一点，毕竟有了网络才可以设置软件源。我建议在昨晚以上几个坑之后做最后一个坑。

这一步我们会向配置一些基础的软件。首先安装中文和树莓派的配置软件：

```bash
sudo apt update && sudo apt upgrade -y && sudo apt install language-pack-zh-hans raspi-config -y
```

这个配置软件虽然是两年前的但现在居然还是能用。上面这条命令运行完后我们就用他来设置本地化。他是一个`tui`程序。使用如下命令运行：

```bash
sudo raspi-config
```

![image-20240826172111390](image-20240826172111390.png)

页面应该长这个样子，使用方向键移动到5 本地化选项使用`enter`进入，然后进入`L1`。找到最下面的`zh_CN.UTF-8`。然后一路`enter`。就设置成功了。

### 基础运维

#### 备份

完成正常的清理环境和一些初始的软件设置后，我们可以进行一些基础的运维操作。首当其冲的将树莓派下电然后把储存卡拔下来给他做一个备份。先将储存卡插到开发环境上然后运行：

```bash
sudo fdisk -l
```

我的机器上看到我的储存卡是这个样子：

```bash
Disk /dev/sda：29.72 GiB，31914983424 字节，62333952 个扇区
Disk model: MassStorageClass
单元：扇区 / 1 * 512 = 512 字节
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x0529037a

设备       启动    起点     末尾     扇区  大小 Id 类型
/dev/sda1  *       2048  1050623  1048576  512M  c W95 FAT32 (LBA)
/dev/sda2       1050624 62333918 61283295 29.2G 83 Linux
```

则表示这个叫`sda`的磁盘设备有两个分区，分别为`sda1`和`sda2`。然后`sda1`是启动分区。知道了这些信息，我们就可以开始备份了。首先是根据这两个信息取消挂在两个磁盘的挂载点

```bash
sudo umount /dev/sda1 
sudo umount /dev/sda2 
```

然后使用以下命令进行拷贝整个磁盘的数据（包括分区表）

```bash
# 备份文件的路径需要包括文件名，应该形如~/backup.img
# 注意这里if后面跟的是整个磁盘设备，不是分区
sudo dd if=/dev/sda of=<备份文件的路径> bs=4M status=progress
# 我的卡是32G的，所有得到的备份文件也是32G的。这肯定不行，可以简单压缩一下。-mmt表示使用尽可能多核压缩
7z a -mmt backup.7z <备份文件的路径>
```

这个过程大概也需要个30分钟左右。之后，在每次生产环境要做一些大的系统软件上的更改的时候都建议做一次备份。恢复的过程肯定比重新搭一遍快。恢复的方法就是把两个参数反过来。

```bash
sudo dd if=<备份文件的路径> of=/dev/sda bs=4M status=progress
```

#### 基础目录

完成备份后，我们做的事情就多了一份保障。现在我们需要了解以下UNIX文件系统的基本常识。在之前，我们使用的操作系统叫做`ubuntu`。它是一种发行版。"发行版"（Distribution）指的是一个操作系统或软件系统的具体版本，它通常包含操作系统核心（如 Linux 内核）、应用程序、工具、库、系统服务以及其他附加软件。一般可以简单将发行版分为三类，一类是类`debian`，包括`ubuntu`和`debian`一种是类红帽，包括是`Fedora`和红帽。第三类就是其他。一般对新手来说类`debian`最好，资料相对新一些。而选择的发行版决定了我们使用什么样的软件来管理系统。所以软件又可以分为两类，一类是发行版提供的，换个发行版就不好使了；一类是发行版没有提供的，一般被称作工具集，比如`busybox`。绝大多数轻量级的`linux`发行版都会它所以也能当作一个标准。

现在我们可以只关注发行版，因为包管理器是发行版这一层的软件提供的。所有类`debian`系的软件除了`snap`之外都是用`dpkg`进行软件的管理。我们常说的`apt`的底层也是在调用`dpkg`。假如我们现在需要使用包管理器。安装一个软件或是C语言使用的库。本质上是下载了一个`.deb`格式的压缩包。压缩包包含了软件的二进制信息和需要的依赖还有可能有的安装前后需要运行的命令。我们先不管每个软件自己设置的命令，通用的部分是一个压缩包。比如他有一些可执行文件和一些静态库。这个压缩包中这些文件的路径就是他们应该在的位置。这意思是假如我们需要把一个文件放在`/bin`目录下，那压缩包的根目录下就会有一个`bin`目录，其中有着我们需要放置的软件。

所以要知道安装究竟是怎么一回事，其实是需要知道操作系统中文件夹约定俗成的用处。一般我们知道下面这些就行（gpt生成）：

* bin：存放系统用户使用的基本命令，如ls、cp等。
* boot：包含启动系统所需的文件，如内核文件和引导加载程序。
* **etc**：包含系统的配置文件，如网络配置、软件配置等。
* lib：存放系统运行时需要的共享库。
* mnt：用于临时挂载其他文件系统的目录。
* proc：虚拟文件系统，提供有关进程和内核的信息。
* run：运行时文件系统，存放系统启动后运行时产生的临时文件。
* sys：虚拟文件系统，提供有关系统硬件和内核的信息。
* usr：存放用户程序和文件，类似于/的另一个根目录。
* dev：包含设备文件，用于与系统硬件设备通信。
* home：存放用户个人文件的根目录。
* media：用于挂载可移动介质，如USB驱动器、CD-ROM等。
* opt：存放可选的软件包的安装目录。
* root：超级用户（root）的家目录。
* sbin：存放系统管理员使用的系统命令。
* srv：存放服务（services）相关的数据或文件。
* tmp：存放临时文件的目录，系统重启时会清空。
* var：存放经常变化的文件，如日志、缓存等。

##### `systemd`

有些目录之后会提到，现在我们只需要关注`etc`目录。`linux`系统中有一个重要的软件叫做`systemd`。`etc`下有一个同名文件夹用于存放他的配置文件。在`systemd`下，要运行的软件被视作服务，有特定条件触发的软件也叫服务。一般一个服务如何运行使用一个`.service`文件描述。大家很少直接在这里放一个文件，而是放一个软链接。软链接在除删除，权限外都和原文件一样。详细了解建议用的时候问`gpt`多问几次就知道了。

说回`systemd`。目前我们并不需要自己编写一个服务文件，当然这在`ai`时代并不困难。我们目前只需要知道两个概念，就是通过命令行程序管理这些服务。一般有两种方法

```shell
systemctl <选项> <服务名>
```

和

```shell
service <服务名> <选项>
```

服务名一般是服务文件的名称，即`xxx.service`的服务名就是`xxx`。选项目前我们只用知道以下两种：

* `start`和`stop`立刻运行或者停止一个服务
* `enable`和`disable`启用或禁用一个服务
  * 这个意思是，假如一个服务设置为开机启动，那么`enable`后在下一次开机就会自己启动
* `status` 查看一个服务运行的状态
  * 一般的命令是有输出的，使用`systemd`启动后就不会直接输出到控制台了，而是会存放在这里

当然还有其他工具可以完成以上这些事情。它们本质上都是一样的，不同工具之间肯定有一些差异，但现在先不考虑。

##### `rc-local`和`crontab`

`systemd`是很好，但坏在有些笨重。假如我们只想运行几个命令或是以特定时间间隔运行几个命令没必要写一个服务文件。这里提到的两个工具就是做这个用的。他们没有完整的`systemd`的功能但对于很多环境是够了。当然，他们也是被`systemd`启动的。首先是`rc-local`，他是负责开机启动的东西，可以简单地通过编辑`/etc/rc.local`文件实现。这个文件可以包含任意命令，它们会在系统启动时以`root`权限执行。不过，现代系统中，`rc-local`通常被`systemd`接管，我们要通过启用`rc-local`服务来使用它。

```bash
sudo systemctl enable rc-local
```

编辑`/ect/rc.local`也需要一定的规则，假设我们要运行的命令是`echo "hello"`

```bash
sleep 10
nohup echo "hello" &
exit 1
```

其中，具体要运行的命令要套一个 `nohup &`，但假如需要阻塞延时的任务不用。在脚本的最末尾需要加一个`exit 1`。

接下来是`crontab`，它主要用于定时任务管理。通过`crontab`，你可以在特定的时间间隔自动执行命令。与`systemd`相比，它更轻量，也更加直观适合定期运行的任务。使用以下命令编辑配置文件：

```bash
crontab -e
```

具体命令的格式在打开的文件中有写。

未完待续...

[^1]: https://www.raspberrypi.com/software/    "树莓派官网"
[^2]: https://en.wikipedia.org/wiki/Multicast_DNS    "mDNS的wiki"
[^3]: https://shumeipai.nxez.com/2013/10/15/raspberry-pi-and-a-network-cable-directly-connected-laptop.html    "网线连接树莓派发现ip"
[^4]: https://zhuanlan.zhihu.com/p/38853178    "串口连接树莓派"
[^5]: https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu-ports/    "清华ubuntu ports镜像"
[^6]: https://www.langzihan.top/2024/02/27/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/27.ubuntu%E5%BD%BB%E5%BA%95%E7%A7%BB%E9%99%A4snap/    "ubuntu 彻底移除 snap"
[^7]: https://cloud-atlas.readthedocs.io/zh-cn/latest/linux/redhat_linux/systemd/systemd_networkd_wlan.html    "使用systemd-networkd配置无线"
