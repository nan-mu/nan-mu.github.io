---
title: 强迫症的llvm+musl编译工具链-musl基础篇
date: 2024-08-18 17:12:31
tags: 
  - musl
  - glibc
  - llvm
  - gcc
  - docker
---

现在我难得有一些较为清闲的时间可以解决一些历史遗留问题。所以就有了这篇文章。我希望掌握自己完成编译+安装一个纯度很高的编译工具链。目的是解决以下套娃问题：

- 使用简单的`gcc`+`glibc`编译`musl`和`llvm`，下面称为直接编译
- 使用自己编译的`musl`+`llvm`编译`musl`+`llvm`（静态+动态），下面成为交叉编译

这么做是因为我不知道怎么做是否有意义以及锻炼一下自己使用`c`项目的能力。除了上面之外，我会尽可能编译出所有架构的原生工具链和主要在`x86`和`aarch64`去交叉编译其他目标的方法。

我的目的是得到一个类似`.deb`包中的`data.tar`文件，该文件在系统目录下解压就可以完成一个非安全的安装操作。这是因为嵌入式`linux`环境当中很有可能没有`make`等工具。我希望我对系统的最小要求就是实现了`busybox`除开网络的大部分功能。

> 我想表达的意思是和交叉工具链区分开。

![image-20240818193647589](image-20240818193647589.png)

我获取`musl`源码的位置是这里[^1]。上面有一个`release`分支和若干版本的标签。编写本文最新的版本标签是`v1.2.5`。所以拉取的所有源码为：

```bash
git clone -b rs-1.0 git://git.musl-libc.org/musl musl-release
git clone -b master git://git.musl-libc.org/musl musl-1.2.5
```

这两者的编译流程应当一样，只是在此展示。编译的关键内容是根目录下的一个脚本。本博客的目的是尽可能了解其中的内容，所以花时间翻译了该脚本的注释和输出。具体内容见仓库[^2]，我非常建议希望深入研究的朋友抽出一些时间看看这个脚本，我认为之前最大的障碍是语言，但这里有一份中文版，也可以点击这个链接只查看脚本内容并在博客的评论区中留下您的意见。我的编译方式是在`musl`的源代码下新建一个`build`文件夹，在这个文件夹中运行：

```shell
../configure
```

我们可以在`build`文件夹下看到：

```bash
tree .
```

其中的`config.mak`就是我们所做的一切配置变量，假如你在后文中发现了一个莫名其妙的`$xxx`那大概率`config.mak`有写，我们可以在开始编译前做最后一次检查。检查之后，在这个目录下运行：

```bash
make # 或者使用多任务编译 make -j
```

编译完后当前文件夹多了个`lib`文件夹和`obj`文件夹。这还不够，我们需要关注安装行为到底做了什么：

```bash
# 因为直接使用make install实际上会触发all规则，但我们实际上只关注install规则的细节，所以使用diff得到两个命令的差集；其中grep -E是使用拓展正则表达式，表达式的意思是只匹配小于开头或者大于开头的行，过滤了diff的行号信息
diff <(make -nB) <(make install -nB) | grep -E "^<|^>" > install.sh
```

通过阅读这条命令的最后几行我们可以知道安装操作是由`tools/install.sh`脚本完成的，这里面代码量较少，总之文字总结下来就是：

- `lib`文件夹复制到了`$prefix/lib`
  - 除开`libc.so`的权限是755，其他都是644
  - 尝试创建`libc.so`到`/lib/ld-musl-x86_64.so.1`的软连接

- 将源码中的`include`中几乎所有的.h文件复制到了`$prefix/include`
- 将`obj`中的一些头文件也复制到了`$prefix/include`
  - 看名字，这类头文件和架构强相关
- 将源码的`arch`文件夹下的一些`.h`文件复制到了`$prefix/include`
- 复制了一个`musl-gcc`脚本，用来更方便的使用`musl`编译，看起来内置了`$prefix`所以安装在哪里都可以。

有了以上这些内容，我们可以先在一个空白的位置使用`make install`安装一次。再根据需要替换适合的架构。但以上这些内容假如我只是手动做了一遍，那就是手动做了一遍🐶。我计划编写一个`github`的`Action`自动帮我编译好我希望的各种奇奇怪怪的架构的工具。所以这篇教程就到此为止了。我已经掌握了`musl`足够多的细节。下一步是薅赛博大善人的羊毛！

[^1]: <https://git.musl-libc.org/cgit/musl> "musl官方git仓库"

[^2]: <https://github.com/nan-mu/musl-learning> "翻译编译脚本的仓库"
