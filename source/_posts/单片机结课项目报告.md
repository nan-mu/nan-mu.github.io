---
title: 单片机结课项目报告
date: 2024-06-05 18:40:30
tags:
  - 单片机
  - 报告
  - esp32c3
  - lcd
---

<!-- # 单片机结课项目报告 -->

## 摘要

我的结课项目是一个远程控制路灯。主要使用淘宝购买的一个无线串口模块进行通信，使用合宙esp32c3开发板和配套的LCD拓展版进行展示功能。除开单片机之外，编写了一个串口应用用于使用`linux`系统控制无线模块。在一开始我没有编写本报告的计划，但既然老师还是有要求，我将在本报告中提到一些教学安排的问题。

## 项目任务

*该部分全文复制自学习通学习任务介绍，没有经过改动。文本框内为本文附加的说明。*

### 任务介绍

基于STC89C52单片机，设计和完成一个无线路灯控制系统，包括方案分析、电路设计、电路制作、功能调试和测试等全部工作，在此过程中学习和实践课程教学内容，掌握单片机各功能部件的使用，练习编程技术，提高搜集信息和整理信息的能力，培养阅读器件数据手册并设计相应电路的能力，提高分析问题和解决问题的能力。此课外实践任务得分计入课程总分。

> > 问题有二，单片机和无线通信。在这里老师没有写明，这个无线通信只能使用`lora`或是`zigbee`通信。其他各个单片机厂商的自有通信方式包括`wifi`和蓝牙都不能使用。所以问题在于，按照老师的要求，基于STC89C52要实现符合要求的通信方式我认为在教学上是不可能的，即一个学生假如仅仅只学习了学院从要求的所有知识后是无法实现的。在与老师沟通后，老师坚持使用这两种通信协议，但单片机可以不做限制。

### 任务要求

1. 分组进行，每组最多2人；
2. 根据功能要求进行方案分析，设计电路和配套程序，并制作调试，电路自己设计和焊接，在基础功能上可以增加功能，体现自己的特点和风采（10分）；
3. 在课程结束之前完成所有要求功能的测试；
4. 任务完成后提交实践报告（20分）；
5. 演示视频内容需包括设计思路和设计方案介绍，硬件电路构成，软件程序结构，各功能的实现方式和测试调试结果等。

![路灯控制系统.drawio.png](thirdDeleted.png)

<center>图一 路灯控制系统示意图</center>

### 项目功能要求

1. 路灯控制系统由一个主控制器和多个单元（路灯）控制器（设计时可用3个）组成（10分）；
2. 主控制器和单元控制器之间采用无线通信方式（20分）；
3. 主控制器有时钟功能，能设定、显示开关灯时间，并控制所有路灯的按时开灯和关灯（20分）；
4. 路灯控制器能根据环境明暗变化，自动开灯和关灯（10分）；
5. 当路灯出现故障（灯不亮）时，路灯控制器能通知主控制器，主控制器发出声光报警，并显示故障路灯编号（10分）；

## 硬件设计

本门课程是单片机课程，在教学内容中并未提及太多电路设计（比如比较自动下载和常用通信协议电路）。加之成本控制（课程所有材料自费完成）我并未自己绘制电路。按照老师的预想和大部分同学的成果，具体功能的模块都是淘宝购买，自行绘制的电路图只是留下了必要接口的系统板。我认为这非常没有必要且学习成果有限（大多同学没有学习过51单片机之外的型号，绘制的系统板就是STC89C52的）所以这部分只提一下我购买的模块：

![O1CN01fODAAG27Z2BXvkssT_!!3201337810.jpg_Q75.jpg_.webp](O1CN01fODAAG27Z2BXvkssT_!!3201337810.jpg_Q75.jpg_.webp)

<center>图1 选用的LoRa模块</center>

![O1CN01U2iJg61gygawWj5Ns_!!3086604211.png_.webp](O1CN01U2iJg61gygawWj5Ns_!!3086604211.png_.webp)

<center>图2 eps32c3开发板和ldc拓展版</center>

## 软件设计

所有软件使用rust开发，在主控制器部分使用`clap`框架开发，但不是本门课程关注部分，源码位于：[https://github.com/nan-mu/lora-esp32c3](https://github.com/nan-mu/lora-esp32c3)。本门课程出于我没有问到的原因与除51单片机之外有关系，所以本报告不会设计编程的具体细节，这里会记录在使用过程遇到的问题和解决方案。

### 异步问题

异步问题的本质是使用在异步操作中已经完善的安全的变量传递方法取代单纯的静态变量读取。在rust的异步操作当中，一般使用类似Promise函数的方式使用函数分割各个可能涉及异步访问的变量。在一定程度上会减少系统调用互斥锁的频率以此提升软件速度。在单片机中，可以通过通用的embassy在mcu厂商的具体实现库下得到异步环境，也可以使用critical-section包提供的跨平台异步实现包进行分配（在单片机no_std当中互斥锁可由软件实现原语或者厂商编写Spinlock提供）。

这与C语言不同的是，rust要求原生静态变量不可更改，不可复用（所有权机制），不可自行操作指针。所以需要类似critical-section提供的互斥锁提供安全访问。具体使用方法可以有两种，一种是类似C语言项目，在模块中直接声明静态变量，只需要自行填写类型或常量类型。也可以使用core中的MaybeUninit将初始化操作延后。另一种是仿照std环境下，需要每一个控制函数都属于一个结构体，初始化结构体时程序入口函数会从需要并行的函数中通过互斥锁安全分发引用指针（理论上来说，可以直接分发引用计数执政，但我没有对此进行过多的了解）。在本项目中我选择的是第一种方式。

### 测试问题

测试问题即对代码的自动化验证。在非嵌入式的rust项目中，cargo工具链原生支持类似数据存储的321原则，即在模块的任何位置可以编写单元测试，在项目中可以包含子项目作为example，在上传crates.io后服务器自动在指定环境中运行集成测试。但在嵌入式或是no_std项目中，一般无法依赖这些工具链。在清华大学的开源rust unikernel 操作系统中，需自行编写测试模块，手动烧写系统后通过控制台调用（当然也可以自动）。在中科院软件所的傲来linux发行版中，使用make编译系统自动编译测试模块完成测试。这类例子和本项目一样，受限于软件的特殊性，测试工作在开发中会占据很大比重。无法使用成型的测试平台进行代替。唯一可行的方案是使用CI/CD通过docker甚至qemu等虚拟化技术完成自动化测试。而问题在于，不尽在本课程中，包括上述项目都在这方面有所欠缺。一方面编写相关测试没有可以使用的脚手架程序，另一方面在中文互联网中这类教程较少或是浮于表面。而目前我也没有找到很好的解决办法。

## 项目问题

### 验收打分问题

问题主要在于老师对于开关灯时间设置上。老师认为，我应该使用引脚控制一个LED实现开关灯。而为了成本控制，我选择了自己已有的LCD屏幕显示一个彩色亮点来模拟LED。老师认为，我没有使用LED而是使用一个SPI屏幕不符合课程要求。我经过反复推演，认为这是错误的。假如存在这一要求，老师应该将我的所有分项扣除，但老师拒绝并且未给出理由。而且在课程说明当中并未出现相关字样，一直以“路灯”而非“LED”。

其次，老师认为，我使用屏幕显示程序报错字样不符合故障报警的要求。在程序中，我重写了".unwrap()"函数，使之在触发不可挽回的错误时将报错发送到屏幕和主控制器中。数学上包含了所有单片机可以感知到的错误。老师认为，出现的故障不是他想要的故障，在这之前，他未在任何地方提到到底是何种故障。他在验收现场举例，假如我使用了一个LED，而这个LED坏了，我的程序要能知道。当时我表示，我使用一个SPI驱动的LCD屏幕作为代替，而假如在初始化SPI控制程序时报错，那也能收到。但在数学上，经过焊接后的整个硬件在没有外力破坏的情况下是不可能报错的。最后老师坚持我没有实现故障报警，也不愿破环硬件看看报错是否真的出现，也没有看看代码判断我所说的是否属实。

最后，在分数量化表的第二页，赫然写着通过 WiFi入网是一个附加功能，可以作为加分项。和之前，老师直接否决我使用WiFi或蓝牙通信的描述完全相反。老师之前说要我仔细阅读使用场景，一个路灯可能相隔几百米，这种情况下不可能使用WiFi或是蓝牙，而且说这两种技术主要涉及物联网，和单片机关系不大。

### 课程问题

在本项目和其他两个方向中，我认为理论上即使学生完美完成了学院要求的所有内容，是无法自行完成这次结课实践乃至学院布置的诸多课程或是比赛内容。老师表示，现在技术发展迅速，学校不可能教授所有技能，所以提供给学生的是机会和问题，以此来驱动学生自学。老师的另一位高年级学生还表示，现在毕业生还面临就业问题，假如所有人都学会了所有技能，那就无法区分。学校通过学生的不同自学成果区分了不同层次的学生（大意，老师表示赞同）。

我对此并无个人看法并对以上老师以及该高年级学长的言论的真实性做保证。除此之外，我在年级中观察得到的一些事件我认为可以对课程安排的相关问题做出参考。

一是竞赛问题，理论上，以赛促学没有问题。问题在于课程与竞赛内容发生偏移却将竞赛作为教学目标。在我们学院当中，所有非学科考试类竞赛的参赛队伍都会从第三方购买材料。而这些比赛却没有规定参赛队伍购买材料的限制。一方面，学生在课程中学习的知识不可能完成比赛所以理论上学生可以购买材料补全这部分。另一方面，要求比赛方不可能给出白名单或是黑名单对购买材料进行限制。黑名单不可能覆盖所有材料品类种类和可能抑制学生自主创新。白名单会导致比赛变成一场考试，极端结果是学生成果趋同导致评分标准内卷。据我了解，在比赛中即使处于竞争关系的学生同样愿意分享自己的购物清单。网上存在很多关于比赛内容的定制化产品并且老师和学生都没有明确抵触。购买完成程度较低的材料的同学往往后悔当初自己没有多花一些钱。在得奖情况上学生的花费和得奖程度程正相关。

以上，市场，比赛方，课程与学生导致了这种模式的不可持续性。并且问题不在于市场和比赛方甚至学生。我认为问题出在课程安排上。

在很多专业课程当中，很多授课内容是在补全已经删减的课程内容。比如单片机课程当中包含了很多计算机操作系统和计算机组成原理，数字电路中包含了离散数学，以及饱受机械学生非议的电工和电路分析。这导致单个课程安排较为臃肿，也对授课老师是一个考验。

另一个问题是专业细分并不明确以及选修课安排问题。这主要体现在我们通信专业的人工智能相关课程上。根据常识，我们通信专业的学生假如想学习人工智能，那应该属于专业细分内容。结果是选择其他方向的学生同样有相关课程（人工智能导论（实际上没有教人工智能导论只在教python编程基础）和人工智能数学基础）。况且在现在人工智能邻域风头正盛的当下，如此安排会让外人怀疑通信专业是“不务正业”，“盲目跟风”。这导致学生课程繁重，挤压了其他课程的时间和学生自学的时间。

最后一个问题是在编程相关课程上，我完成的所有编程相关课程都在教授已经被替代甚至淘汰的技术。和我了解的其他大学所教授的课程内容相差很大。我与具体授课老师询问得知，只有一位老师了解过较新的技术动向，其余老师甚至没有听说过。当然这是因为老师的研究方向与这门课程不太重合，但我们的教学内容落后是事实。我这里并不是说课程不应该教基础知识而追求新技术，而是对基础的认知也在随发展发生变化。反而我们的课程内容没有发生变化才是问题。在过去微积分刚刚发明的年代不教授微积分情有可原，但我认为在编程领域，我们没有在教授“微积分”。而这些老旧的课程同样占据了很多时间。

以上，期待老师反馈。
