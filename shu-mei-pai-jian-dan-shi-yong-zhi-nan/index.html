<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <!-- Enable responsiveness on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
      
        
        <meta name="description" content="这篇文章的目的是为了让读者尽快掌握将树莓派部署到生产环境中的用法。以树莓派5和树莓派4b为例，前者使用ubuntu 24 Noble而后者使用ubuntu 22 Jammy。我将尽量照顾所有细节让初学者既明白如何操作也明白此种三昧。本教程假设工作在类debian发行版上。" />
        <meta property="og:description" content="这篇文章的目的是为了让读者尽快掌握将树莓派部署到生产环境中的用法。以树莓派5和树莓派4b为例，前者使用ubuntu 24 Noble而后者使用ubuntu 22 Jammy。我将尽量照顾所有细节让初学者既明白如何操作也明白此种三昧。本教程假设工作在类debian发行版上。" />
        <meta property="twitter:description" content="这篇文章的目的是为了让读者尽快掌握将树莓派部署到生产环境中的用法。以树莓派5和树莓派4b为例，前者使用ubuntu 24 Noble而后者使用ubuntu 22 Jammy。我将尽量照顾所有细节让初学者既明白如何操作也明白此种三昧。本教程假设工作在类debian发行版上。" />
      
    

    <!-- Title -->
      

    <title>
    
    树莓派简单使用指南
    
</title>
    <meta property="og:title" content="" />
    <meta name="twitter:title" content="" />

    <!-- Additional Facebook Meta Tags -->
    <meta property="og:site_name" content="" />
    <meta
      property="og:url"
      content="https:&#x2F;&#x2F;nan-mu.asia&#x2F;shu-mei-pai-jian-dan-shi-yong-zhi-nan&#x2F;"
    />
    <meta
      property="og:type"
      content="article"
    />
    <meta property="og:title" content="树莓派简单使用指南" />
    <meta
      property="og:image"
      content="https:&#x2F;&#x2F;nan-mu.asia/icons/favicon/web-app-manifest-512x512.png"
    />

    <!-- Additional Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      property="twitter:url"
      content="https:&#x2F;&#x2F;nan-mu.asia&#x2F;shu-mei-pai-jian-dan-shi-yong-zhi-nan&#x2F;"
    />
    <meta name="twitter:title" content="树莓派简单使用指南" />
    <meta
      name="twitter:image"
      content="https:&#x2F;&#x2F;nan-mu.asia/icons/favicon/web-app-manifest-512x512.png"
    />

    <!-- Favicons -->
    
    <link
      rel="icon"
      type="image/png"
      href="https:&#x2F;&#x2F;nan-mu.asia/icons/favicon/favicon-96x96.png"
      sizes="96x96"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="https:&#x2F;&#x2F;nan-mu.asia/icons/favicon/favicon.svg"
    />
    <link
      rel="shortcut icon"
      href="https:&#x2F;&#x2F;nan-mu.asia/icons/favicon/favicon.ico"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https:&#x2F;&#x2F;nan-mu.asia/icons/favicon/apple-touch-icon.png"
    />
    <meta name="apple-mobile-web-app-title" content="树莓派简单使用指南" />
    <link
      rel="manifest"
      href="https:&#x2F;&#x2F;nan-mu.asia/icons/favicon/site.webmanifest"
    />
    

    <!-- RSS Feed -->
    
    <link
      rel="alternate"
      type="application/atom+xml"
      title="RSS"
      href="https://nan-mu.asia/atom.xml"
    />
    

    <!-- Load Styles -->
    
      <link
        rel="stylesheet"
        href="https://nan-mu.asia/site.css"
      />
    

    <!-- Load Fonts -->
    <!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">


    <!-- Pass Theme Preference as Data Attribute -->
    <script src="https://nan-mu.asia/js/init-theme.js"></script>

    <!-- Reference return to click position script -->
    <script defer src="https://nan-mu.asia/js/reference-return.js"></script>

    <!-- Additional scripts -->
    
      
        <script defer src="https://nan-mu.asia/js/codeblock.js"></script>
      
      
        <script src="https://nan-mu.asia/js/toggle-theme.js"></script>
      
      
<!-- MathJax script for rendering LaTeX math equations -->
<script src="https://nan-mu.asia/js/mathjax-config.js"></script>
<script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"
  async
></script>


      
<script type="text/javascript" src="https://nan-mu.asia/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://nan-mu.asia/js/search.js"></script>

    
  </head>

  <!-- Body element (contents of the page) -->
  <body class="hack main container">
    
  
    
    
      
  
  <section class="nav-header">
    <nav
      itemscope
      itemtype="http://schema.org/SiteNavigationElement"
      class="navbar"
    >
      <section class="nav-links">
        
        <a
          itemprop="url"
          class=""
          href="https://nan-mu.asia"
        >
          <span itemprop="name">Home</span>
        </a>
        
        <a
          itemprop="url"
          class=""
          href="https://nan-mu.asia/tags"
        >
          <span itemprop="name">Tags</span>
        </a>
        
        <a
          itemprop="url"
          class=""
          href="https://nan-mu.asia/categories"
        >
          <span itemprop="name">Categories</span>
        </a>
        
      </section>
    </nav>
    <aside class="user-actions-container">
      
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        class="search-icon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
        />
      </svg>
      <input type="text" id="search" placeholder="Search..." />
      <section class="search-results" aria-live="polite">
        <article class="search-results__items" role="list"></article>
      </section>
       
      <a id="dark-mode-toggle" href="#">
        <img
          src="https://nan-mu.asia/icons/sun.svg"
          id="sun-icon"
          style="filter: invert(1)"
          alt="Light mode"
        />
        <img
          src="https://nan-mu.asia/icons/moon.svg"
          id="moon-icon"
          alt="Dark mode"
        />
      </a>
       
      <a
        href="https://nan-mu.asia/atom.xml"
        class="feed-icon"
        rel="noopener noreferrer"
      >
        <img
          src="https://nan-mu.asia/icons/rss.svg"
          id="rss-icon"
          alt="RSS feed"
          class="social-icon"
        />
      </a>
       
      <a
        href="https:&#x2F;&#x2F;github.com&#x2F;nan-mu"
        class="feed-icon"
        rel="noopener noreferrer"
      >
        <img
          src="https://nan-mu.asia/icons/github.svg"
          id="github-icon"
          alt="GitHub"
          class="social-icon"
        />
      </a>
      
    </aside>
  </section>
  

    


    <main>
      

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">树莓派简单使用指南</h1>
        <data class="muted">
    <svg class="icon i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <data>28 minute read</data>
    <svg class="icon i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2024-08-26
</data>
    </header>

    <article itemprop="articleBody">
        
            <p>这篇文章的目的是为了让读者尽快掌握将树莓派部署到生产环境中的用法。以树莓派5和树莓派4b为例，前者使用<code>ubuntu 24 Noble</code>而后者使用<code>ubuntu 22 Jammy</code>。我将尽量照顾所有细节让初学者既明白如何操作也明白此种三昧。本教程假设工作在类<code>debian</code>发行版上。</p>

            

            <!-- Render the rest of the content after removing the summary portion -->
            
<span id="continue-reading"></span><h2 id="shao-lu"><a class="zola-anchor" href="#shao-lu" aria-label="Anchor link for: shao-lu">烧录</a></h2>
<p>一切的开始始于一次烧录。在这里，烧录的意思是在一个磁盘设备上创建很多分区，这些分区包含了我们需要的一切。得到这些你首先需要准备一个SD卡，一个读卡器。我们将要使用的SD卡将会被格式化所有内容所以请做好准备。</p>
<p>软件方面需要在树莓派官网下载最新版本的烧录器。目前树莓派官方开发的烧录器似乎刚到一岁，从开发周期来看还需要一些沉淀。所以最好每次开始烧录行为时都检查一下是否在使用最新的软件。一种方法是在树莓派的[官方网站<sup class="footnote-reference"><a href="#1">1</a></sup>]<sup class="footnote-reference"><a href="#1">1</a></sup>找到下载链接。或者直接使用命令安装：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> apt install rpi-imager
</span></code></pre>
<p>无论以何种方式，我们现在都可以得到一个图形界面，像是这样：</p>
<p><img src="https://img.nan-mu.asia/picgo/image-20240826100251610.png" alt="image-20240826100251610" /></p>
<p>我们开始操作前，请确保SD卡已经准备就绪。上面三个按钮是第一个坑，正确的设置流程必须重左往右点。第一个按钮选择树莓派型号，第二个按钮选择我们要安装的发行版。我们计划安装的<code>ubuntu</code>发行版在<code>Other general-purpose OS</code>。选择<code>ubuntu</code>然后下个页面有三个选项，分别是桌面版本，服务器版本和核心版本。我们选择中间的服务器版本。选择后窗体会退出，以便于我们点击最后一个按钮，之后进入具体的配置，点击右下的<code>NEXT</code>。</p>
<p>一般情况下你可能见到一个询问你是否使用自定义配置的页面，我们选择最左侧的编辑设置</p>
<p><img src="https://img.nan-mu.asia/picgo/image-20240826102109525.png" alt="image-20240826102109525" /></p>
<p>设置的窗体如图所示，有三个标签页我们每一个都有关注。第一个是通用的一些设置：</p>
<ul>
<li>设置主机名：这个适用于<code>mDNS</code>网络发现，最好开上。细节推荐阅读[这里<sup class="footnote-reference"><a href="#2">2</a></sup>]<sup class="footnote-reference"><a href="#2">2</a></sup></li>
<li>设置用户名和密码，这个简单。
<ul>
<li>其中可以看到密码特别长，这是经过加密后的密码，是我上一次输的。我们可以不用动。</li>
</ul>
</li>
<li>配置<code>WiFi</code>：这个相对重要，一开始假如树莓派无法接入显示屏的话需要连接一个可以显示<code>IP</code>的手机<code>WiFi</code>。当然最方便的就是这里直接准备好工作环境的<code>WiFi</code>（假如需要的话）</li>
<li>语言设置：没什么好说的</li>
</ul>
<p>然后是第二页</p>
<p><img src="https://img.nan-mu.asia/picgo/image-20240826104530606.png" alt="image-20240826104530606" /></p>
<p>这里主要设置<code>ssh</code>登陆相关，不建议设置第二项，因为我们可能会使用串口登陆。</p>
<p>第三页没什么可说的。</p>
<p>至此我们剩下的内容就是一路保存一路下一步。时硬件不同烧录过程可能会在半个小时左右完成。然后，我们就可以直接插到树莓派中使用了。</p>
<h2 id="kai-ji"><a class="zola-anchor" href="#kai-ji" aria-label="Anchor link for: kai-ji">开机</a></h2>
<p>插上SD卡，向typec口上插上电源，树莓派就开机了。我们的第一个任务是知道树莓派的<code>ip</code>地址，后很多中方法：</p>
<ul>
<li>直接连接显示器和键盘，你会在命令行里登陆。登陆后输入<code>hostname -I</code>找到和你主机在同一网段的<code>ip</code>地址。</li>
<li>假如你使用的是可以查看连接设备ip地址的手机WiFi热点，那你已经知道了</li>
<li>使用网线链接，但这个我没有尝试过，我认为[这篇教程<sup class="footnote-reference"><a href="#3">3</a></sup>]<sup class="footnote-reference"><a href="#3">3</a></sup>值得参考。</li>
<li>使用串口连接，这个我只在树莓派4B上成功过，需要硬件，[这篇教程<sup class="footnote-reference"><a href="#4">4</a></sup>]<sup class="footnote-reference"><a href="#4">4</a></sup>值得参考。</li>
</ul>
<p>有了<code>ip</code>地址之后我们就可以回到自己的<code>pc</code>上操作树莓派。一般，我们需要将树莓派视作生产环境，我们自己的设备或者服务器视作开发环境。两个环境需要隔离开，之后做好准备之后才将软件部署到生产环境当中。这是因为在生产环境中做开发很不安全。而我们就需要一个能够快速部署软件的方法。总之，我们要在自己开发用电脑上使用<code>openssh</code>。</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="font-style:italic;color:#5f697a;"># 形如ssh xxx@10.1.1.1
</span><span style="color:#eb6772;">ssh </span><span style="color:#adb7c9;">&lt;</span><span style="color:#abb2bf;">树莓派上用户名</span><span style="color:#adb7c9;">&gt;</span><span style="color:#abb2bf;">@</span><span style="color:#adb7c9;">&lt;</span><span style="color:#abb2bf;">树莓派的ip</span><span style="color:#adb7c9;">&gt;
</span></code></pre>
<p>假如无法连接，大概率是没有选择正确的<code>ip</code>。使用<code>ping</code>命令检查我们的开发电脑能否连接树莓派</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">ping </span><span style="color:#adb7c9;">&lt;</span><span style="color:#abb2bf;">树莓派的ip</span><span style="color:#adb7c9;">&gt;
</span></code></pre>
<h3 id="qing-li-huan-jing"><a class="zola-anchor" href="#qing-li-huan-jing" aria-label="Anchor link for: qing-li-huan-jing">清理环境</a></h3>
<p>正确连接之后还有几项工作。首先第一步是换源，我们需要将树莓派原本的<code>apt</code>软件镜像源更换为国内的快速镜像源，建议使用物理位置距离自己近的，这里以清华源为例。在这之前需要明确一个概念，在 <code>ubuntu</code> 中，软件源的名称中带有 <code>-ports</code>（如 <code>ports.ubuntu.com</code>）和不带 <code>-ports</code> 的区别通常与支持的硬件架构相关。而我们的树莓派的架构是<code>Cortex-A76</code>的<code>aarch64</code>，在清华源中应该使用[这个<sup class="footnote-reference"><a href="#5">5</a></sup>]<sup class="footnote-reference"><a href="#5">5</a></sup>。似乎现在网上有些资料说只要是<code>aarch64</code>的架构，非<code>ports</code>就能用，但我实际测试下来并非如此，可能和清华源的规划有关？</p>
<p>第二个坑是软件源格式</p>
<p><img src="https://img.nan-mu.asia/picgo/image-20240826133714960.png" alt="image-20240826133714960" /></p>
<p>图片中为清华帮你做好的两种镜像格式，传统格式的用法是将文本框内的所有东西写到<code>/etc/apt/sources.list</code>，<code>DEB822</code>格式也是将下面文本框内的所有东西写道<code>/etc/apt/sources.list.d/ubuntu.sources</code>。<code>.d</code>为后缀的文件夹意为拓展；比如这里的<code>sources.list.d</code>意思是<code>sources.list</code>的拓展。以前大家把所有东西都直接写到<code>sources.list</code>导致用户难以维护这个文件，所以就有了<code>DEB822</code>格式。<strong><u>注意，<code>DEB822</code>格式是<code>ubuntu 24</code>推荐的，所以建议只在树莓派5上使用它；在树莓派4B上使用传统格式最好。</u></strong></p>
<p>这里还有一个小点，清华的软件源中有一个部分是<code>ubuntu</code>官方的安全补丁源。可以注释，因为他们有另一套机制管理安全补丁，这个后面再说。</p>
<p>第三个坑是<code>snap</code>。他是<code>ubuntu</code>官方在推的一个包管理器。技术上是将每一个软件直接放在一个容器当中。起到版本隔离的效果。实际上它的速度，体积，权限管理还有安全问题一直饱受社区诟病。不推荐在生产环境或是开发环境留着<code>snap</code>所以我们现在要做的就是删掉它。具体流程有一篇很好的[博文<sup class="footnote-reference"><a href="#6">6</a></sup>]<sup class="footnote-reference"><a href="#6">6</a></sup>。我就不多赘述了。</p>
<p>然后是第四个坑，我们来处理网络问题。简单来说，<code>linux</code>中有很多配置网络的工具，比如<code>systemd</code>和<code>NetWorkManager</code>。提到这两个软件的原因是我没法在我自己叠树莓派5上同时使用他们。<code>NetWorkManager</code>有一个很好的<code>tui</code>程序叫<code>nmtui</code>。拿它来配置有线网无线网都很方便，配置静态<code>ip</code>和使用<code>dhcp</code>自动请求分配<code>ip</code>也很方便。</p>
<blockquote>
<p><code>TUI</code>（Text-based User Interface）指的是基于文本的用户界面，这种界面在终端窗口中呈现，而不是使用图形界面（<code>GUI</code>）。<code>TUI</code> 是一种以文本为基础的界面，通常用于命令行界面（<code>CLI</code>）程序中，为用户提供一种交互方式，常见于 Linux 和 UNIX 系统中。</p>
</blockquote>
<p>问题就是树莓派5不知道干了什么，导致自己的<code>raspberrypi OS</code>和自己改的<code>ubuntu 24</code>都无法使用<code>nmtui</code>。而根据我使用4B的经验，它们使用的<code>systemd</code>的工具链。其实这种方法很适合静态<code>ip</code>，只用写一些配置文件我们甚至不用启动机器就能完成网络的配置。可惜问题处在<code>dhcp</code>自动分配<code>ip</code>上。这里还是推荐一篇[教程<sup class="footnote-reference"><a href="#7">7</a></sup>]<sup class="footnote-reference"><a href="#7">7</a></sup>。</p>
<p>其实网络的优先级需要高一点，毕竟有了网络才可以设置软件源。我建议在昨晚以上几个坑之后做最后一个坑。</p>
<p>这一步我们会向配置一些基础的软件。首先安装中文和树莓派的配置软件：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> apt update </span><span style="color:#adb7c9;">&amp;&amp; </span><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> apt upgrade</span><span style="color:#eb6772;"> -y </span><span style="color:#adb7c9;">&amp;&amp; </span><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> apt install language-pack-zh-hans raspi-config</span><span style="color:#eb6772;"> -y
</span></code></pre>
<p>这个配置软件虽然是两年前的但现在居然还是能用。上面这条命令运行完后我们就用他来设置本地化。他是一个<code>tui</code>程序。使用如下命令运行：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> raspi-config
</span></code></pre>
<p><img src="https://img.nan-mu.asia/picgo/image-20240826172111390.png" alt="image-20240826172111390" /></p>
<p>页面应该长这个样子，使用方向键移动到5 本地化选项使用<code>enter</code>进入，然后进入<code>L1</code>。找到最下面的<code>zh_CN.UTF-8</code>。然后一路<code>enter</code>。就设置成功了。</p>
<h3 id="ji-chu-yun-wei"><a class="zola-anchor" href="#ji-chu-yun-wei" aria-label="Anchor link for: ji-chu-yun-wei">基础运维</a></h3>
<h4 id="bei-fen"><a class="zola-anchor" href="#bei-fen" aria-label="Anchor link for: bei-fen">备份</a></h4>
<p>完成正常的清理环境和一些初始的软件设置后，我们可以进行一些基础的运维操作。首当其冲的将树莓派下电然后把储存卡拔下来给他做一个备份。先将储存卡插到开发环境上然后运行：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> fdisk</span><span style="color:#eb6772;"> -l
</span></code></pre>
<p>我的机器上看到我的储存卡是这个样子：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">Disk</span><span style="color:#abb2bf;"> /dev/sda：29.72 GiB，31914983424 字节，62333952 个扇区
</span><span style="color:#eb6772;">Disk</span><span style="color:#abb2bf;"> model: MassStorageClass
</span><span style="color:#eb6772;">单元：扇区</span><span style="color:#abb2bf;"> / 1 </span><span style="color:#adb7c9;">*</span><span style="color:#abb2bf;"> 512 = 512 字节
</span><span style="color:#eb6772;">扇区大小</span><span style="color:#abb2bf;">(逻辑/物理)</span><span style="color:#eb6772;">：512</span><span style="color:#abb2bf;"> 字节 / 512 字节
</span><span style="color:#eb6772;">I/O</span><span style="color:#abb2bf;"> 大小(最小/最佳)</span><span style="color:#eb6772;">：512</span><span style="color:#abb2bf;"> 字节 / 512 字节
</span><span style="color:#eb6772;">磁盘标签类型：dos
</span><span style="color:#eb6772;">磁盘标识符：0x0529037a
</span><span style="color:#abb2bf;">
</span><span style="color:#eb6772;">设备</span><span style="color:#abb2bf;">       启动    起点     末尾     扇区  大小 Id 类型
</span><span style="color:#eb6772;">/dev/sda1  </span><span style="color:#adb7c9;">*</span><span style="color:#abb2bf;">       2048  1050623  1048576  512M  c W95 FAT32 (LBA)
</span><span style="color:#eb6772;">/dev/sda2</span><span style="color:#abb2bf;">       1050624 62333918 61283295 29.2G 83 Linux
</span></code></pre>
<p>则表示这个叫<code>sda</code>的磁盘设备有两个分区，分别为<code>sda1</code>和<code>sda2</code>。然后<code>sda1</code>是启动分区。知道了这些信息，我们就可以开始备份了。首先是根据这两个信息取消挂在两个磁盘的挂载点</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> umount /dev/sda1 
</span><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> umount /dev/sda2 
</span></code></pre>
<p>然后使用以下命令进行拷贝整个磁盘的数据（包括分区表）</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="font-style:italic;color:#5f697a;"># 备份文件的路径需要包括文件名，应该形如~/backup.img
</span><span style="font-style:italic;color:#5f697a;"># 注意这里if后面跟的是整个磁盘设备，不是分区
</span><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> dd if=/dev/sda of=</span><span style="color:#adb7c9;">&lt;</span><span style="color:#abb2bf;">备份文件的路径</span><span style="color:#adb7c9;">&gt;</span><span style="color:#abb2bf;"> bs=4M status=progress
</span><span style="font-style:italic;color:#5f697a;"># 我的卡是32G的，所有得到的备份文件也是32G的。这肯定不行，可以简单压缩一下。-mmt表示使用尽可能多核压缩
</span><span style="color:#eb6772;">7z</span><span style="color:#abb2bf;"> a</span><span style="color:#eb6772;"> -mmt</span><span style="color:#abb2bf;"> backup.7z </span><span style="color:#adb7c9;">&lt;</span><span style="color:#abb2bf;">备份文件的路径</span><span style="color:#adb7c9;">&gt;
</span></code></pre>
<p>这个过程大概也需要个30分钟左右。之后，在每次生产环境要做一些大的系统软件上的更改的时候都建议做一次备份。恢复的过程肯定比重新搭一遍快。恢复的方法就是把两个参数反过来。</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> dd if=</span><span style="color:#adb7c9;">&lt;</span><span style="color:#abb2bf;">备份文件的路径</span><span style="color:#adb7c9;">&gt;</span><span style="color:#abb2bf;"> of=/dev/sda bs=4M status=progress
</span></code></pre>
<h4 id="ji-chu-mu-lu"><a class="zola-anchor" href="#ji-chu-mu-lu" aria-label="Anchor link for: ji-chu-mu-lu">基础目录</a></h4>
<p>完成备份后，我们做的事情就多了一份保障。现在我们需要了解以下UNIX文件系统的基本常识。在之前，我们使用的操作系统叫做<code>ubuntu</code>。它是一种发行版。"发行版"（Distribution）指的是一个操作系统或软件系统的具体版本，它通常包含操作系统核心（如 Linux 内核）、应用程序、工具、库、系统服务以及其他附加软件。一般可以简单将发行版分为三类，一类是类<code>debian</code>，包括<code>ubuntu</code>和<code>debian</code>一种是类红帽，包括是<code>Fedora</code>和红帽。第三类就是其他。一般对新手来说类<code>debian</code>最好，资料相对新一些。而选择的发行版决定了我们使用什么样的软件来管理系统。所以软件又可以分为两类，一类是发行版提供的，换个发行版就不好使了；一类是发行版没有提供的，一般被称作工具集，比如<code>busybox</code>。绝大多数轻量级的<code>linux</code>发行版都会它所以也能当作一个标准。</p>
<p>现在我们可以只关注发行版，因为包管理器是发行版这一层的软件提供的。所有类<code>debian</code>系的软件除了<code>snap</code>之外都是用<code>dpkg</code>进行软件的管理。我们常说的<code>apt</code>的底层也是在调用<code>dpkg</code>。假如我们现在需要使用包管理器。安装一个软件或是C语言使用的库。本质上是下载了一个<code>.deb</code>格式的压缩包。压缩包包含了软件的二进制信息和需要的依赖还有可能有的安装前后需要运行的命令。我们先不管每个软件自己设置的命令，通用的部分是一个压缩包。比如他有一些可执行文件和一些静态库。这个压缩包中这些文件的路径就是他们应该在的位置。这意思是假如我们需要把一个文件放在<code>/bin</code>目录下，那压缩包的根目录下就会有一个<code>bin</code>目录，其中有着我们需要放置的软件。</p>
<p>所以要知道安装究竟是怎么一回事，其实是需要知道操作系统中文件夹约定俗成的用处。一般我们知道下面这些就行（gpt生成）：</p>
<ul>
<li>bin：存放系统用户使用的基本命令，如ls、cp等。</li>
<li>boot：包含启动系统所需的文件，如内核文件和引导加载程序。</li>
<li><strong>etc</strong>：包含系统的配置文件，如网络配置、软件配置等。</li>
<li>lib：存放系统运行时需要的共享库。</li>
<li>mnt：用于临时挂载其他文件系统的目录。</li>
<li>proc：虚拟文件系统，提供有关进程和内核的信息。</li>
<li>run：运行时文件系统，存放系统启动后运行时产生的临时文件。</li>
<li>sys：虚拟文件系统，提供有关系统硬件和内核的信息。</li>
<li>usr：存放用户程序和文件，类似于/的另一个根目录。</li>
<li>dev：包含设备文件，用于与系统硬件设备通信。</li>
<li>home：存放用户个人文件的根目录。</li>
<li>media：用于挂载可移动介质，如USB驱动器、CD-ROM等。</li>
<li>opt：存放可选的软件包的安装目录。</li>
<li>root：超级用户（root）的家目录。</li>
<li>sbin：存放系统管理员使用的系统命令。</li>
<li>srv：存放服务（services）相关的数据或文件。</li>
<li>tmp：存放临时文件的目录，系统重启时会清空。</li>
<li>var：存放经常变化的文件，如日志、缓存等。</li>
</ul>
<h5 id="systemd"><a class="zola-anchor" href="#systemd" aria-label="Anchor link for: systemd"><code>systemd</code></a></h5>
<p>有些目录之后会提到，现在我们只需要关注<code>etc</code>目录。<code>linux</code>系统中有一个重要的软件叫做<code>systemd</code>。<code>etc</code>下有一个同名文件夹用于存放他的配置文件。在<code>systemd</code>下，要运行的软件被视作服务，有特定条件触发的软件也叫服务。一般一个服务如何运行使用一个<code>.service</code>文件描述。大家很少直接在这里放一个文件，而是放一个软链接。软链接在除删除，权限外都和原文件一样。详细了解建议用的时候问<code>gpt</code>多问几次就知道了。</p>
<p>说回<code>systemd</code>。目前我们并不需要自己编写一个服务文件，当然这在<code>ai</code>时代并不困难。我们目前只需要知道两个概念，就是通过命令行程序管理这些服务。一般有两种方法</p>
<pre data-lang="shell" style="background-color:#2b303b;color:#6c7079;" class="language-shell "><code class="language-shell" data-lang="shell"><span style="color:#abb2bf;">systemctl &lt;选项&gt; &lt;服务名&gt;
</span></code></pre>
<p>和</p>
<pre data-lang="shell" style="background-color:#2b303b;color:#6c7079;" class="language-shell "><code class="language-shell" data-lang="shell"><span style="color:#abb2bf;">service &lt;服务名&gt; &lt;选项&gt;
</span></code></pre>
<p>服务名一般是服务文件的名称，即<code>xxx.service</code>的服务名就是<code>xxx</code>。选项目前我们只用知道以下两种：</p>
<ul>
<li><code>start</code>和<code>stop</code>立刻运行或者停止一个服务</li>
<li><code>enable</code>和<code>disable</code>启用或禁用一个服务
<ul>
<li>这个意思是，假如一个服务设置为开机启动，那么<code>enable</code>后在下一次开机就会自己启动</li>
</ul>
</li>
<li><code>status</code> 查看一个服务运行的状态
<ul>
<li>一般的命令是有输出的，使用<code>systemd</code>启动后就不会直接输出到控制台了，而是会存放在这里</li>
</ul>
</li>
</ul>
<p>当然还有其他工具可以完成以上这些事情。它们本质上都是一样的，不同工具之间肯定有一些差异，但现在先不考虑。</p>
<h5 id="rc-localhe-crontab"><a class="zola-anchor" href="#rc-localhe-crontab" aria-label="Anchor link for: rc-localhe-crontab"><code>rc-local</code>和<code>crontab</code></a></h5>
<p><code>systemd</code>是很好，但坏在有些笨重。假如我们只想运行几个命令或是以特定时间间隔运行几个命令没必要写一个服务文件。这里提到的两个工具就是做这个用的。他们没有完整的<code>systemd</code>的功能但对于很多环境是够了。当然，他们也是被<code>systemd</code>启动的。首先是<code>rc-local</code>，他是负责开机启动的东西，可以简单地通过编辑<code>/etc/rc.local</code>文件实现。这个文件可以包含任意命令，它们会在系统启动时以<code>root</code>权限执行。不过，现代系统中，<code>rc-local</code>通常被<code>systemd</code>接管，我们要通过启用<code>rc-local</code>服务来使用它。</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">sudo</span><span style="color:#abb2bf;"> systemctl enable rc-local
</span></code></pre>
<p>编辑<code>/ect/rc.local</code>也需要一定的规则，假设我们要运行的命令是<code>echo "hello"</code></p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">sleep</span><span style="color:#abb2bf;"> 10
</span><span style="color:#eb6772;">nohup</span><span style="color:#abb2bf;"> echo </span><span style="color:#9acc76;">&quot;hello&quot; </span><span style="color:#adb7c9;">&amp;
</span><span style="color:#5ebfcc;">exit</span><span style="color:#abb2bf;"> 1
</span></code></pre>
<p>其中，我们能预见到他不会自行结束的命令要套一个 <code>nohup &amp;</code>，像<code>sleep</code>这样我们知道他会结束（并且特别希望他能让后面的命令等一等）的，就不用。然后，<code>nohup</code>理论上会将这个命令的输出放到一个文件中，具体是哪个文件它回输出到<code>systemctl statue rc-local</code>的，没有使用<code>nohup</code>的命令也会将输出放到这里面。最后注意在脚本的最末尾需要加一个<code>exit 1</code>。</p>
<p>接下来是<code>crontab</code>，它主要用于定时任务管理。通过<code>crontab</code>，你可以在特定的时间间隔自动执行命令。与<code>systemd</code>相比，它更轻量，也更加直观适合定期运行的任务。使用以下命令编辑配置文件：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#eb6772;">crontab -e
</span></code></pre>
<p>具体命令的格式在打开的文件中有写。这个用的可能会比较少</p>
<h3 id="yue-ding"><a class="zola-anchor" href="#yue-ding" aria-label="Anchor link for: yue-ding">约定</a></h3>
<p>我们可能经常听过实习生删库跑路的故事。这是内部人员开发权限管理不当导致的。也就是说，在这方面有一些行业内的约定防止这类事情的发生。</p>
<p>一个事情是环境变量。这也和自启动脚本有关。有一些方式，比<code>rc-local</code>和<code>crontab</code>还要简单，他们的意思是在用户登陆的时候运行。这时候就很适合设置环境变量。登陆的具体意思是，每一次，我们通过<code>ssh</code>或者串口或者屏幕上从<code>gui</code>登陆都算登陆。假设我们的工作环境是使用ssh登陆</p>
<p>当你使用 SSH 登录到一台服务器，并且默认的 Shell 是 Bash 时，启动脚本的加载顺序会有所不同。以下是具体的加载顺序：</p>
<ol>
<li>
<p><strong>系统级全局配置文件</strong>：</p>
<ul>
<li><strong><code>/etc/profile</code></strong>：首先，Bash 会加载这个系统级的全局配置文件。它为所有用户设置了一些默认的环境变量和系统范围的配置。</li>
</ul>
</li>
<li>
<p><strong>用户级的配置文件</strong>：</p>
<ul>
<li><strong><code>~/.bash_profile</code></strong>、<strong><code>~/.bash_login</code></strong>、<strong><code>~/.profile</code></strong>（按顺序）：
<ul>
<li>Bash 会按照顺序查找并执行这三个文件中的第一个存在的文件：
<ul>
<li>如果 <code>~/.bash_profile</code> 存在，它将被执行。</li>
<li>如果 <code>~/.bash_profile</code> 不存在，系统会查找并执行 <code>~/.bash_login</code>。</li>
<li>如果 <code>~/.bash_login</code> 也不存在，系统会查找并执行 <code>~/.profile</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>一个例外是**<code>~/.bashrc</code>**，默认情况下，<code>~/.bashrc</code> 并不会被直接加载，因为这是一个非登录 Shell 的配置文件。然而，<code>~/.bash_profile</code> 通常会包含一行代码来手动加载 <code>~/.bashrc</code>，例如：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#6c7079;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#cd74e8;">if </span><span style="color:#5ebfcc;">[ </span><span style="color:#eb6772;">-f ~</span><span style="color:#abb2bf;">/.bashrc </span><span style="color:#5ebfcc;">]</span><span style="color:#adb7c9;">; </span><span style="color:#cd74e8;">then
</span><span style="color:#abb2bf;">    </span><span style="color:#5ebfcc;">. </span><span style="color:#eb6772;">~</span><span style="color:#abb2bf;">/.bashrc
</span><span style="color:#cd74e8;">fi
</span></code></pre>
<p>这意味着在登录时，<code>~/.bashrc</code> 的配置也会被执行。其中我们可以看到这些文件可以分为两类，一类是<code>/etc/profile</code>，因为他在一个系统级的目录下，所有用户使用的<code>/etc/profile</code>都是一个。另一类就是在用户自己的家目录下，所以每个用户大概率是不一样的。也就是说，假如一个东西，我们认为别人也要用且不会干扰到别人的环境，那就应该放到<code>/etc/profile</code>。反之放到另一类配置文件当中。目前，<strong>我认为存在这样一种约定，我们只使用<code>.bashrc</code>作为用户级的配置文件</strong>。我猜是因为他文件名很短。</p>
<p>解决了放在那里的问题，我们还要知道放什么。上面提到，我们可以通过<code>systemctl status rc-local</code>的方式查看其中命令的输出（除开使用了<code>nohup</code>重定向输出的）。这些命令可能是我们业务的脚本，可能是我们监控程序的启动入口。一个他们就是和一个服务一样的东西，<strong>我们不会希望每次登陆就运行一次</strong>；这是第一个条件。另外有一些<strong>别名</strong>，意思是一条指令的另一个名字。这是给人用的，那<strong>我们肯定希望我们每次登陆这个东西必定会存在</strong>；<strong>环境变量</strong>和他也是一样。</p>
<p>上面提到了环境变量，总之这是我们向程序传递参数的一种方式。第三种约定和环境变量相关。有些应用程序会需要一个密码来验证。我们当然不希望这个密码谁都可以看到。一般安全的方法是放在一个文件中。然后让程序去读取这个文件。这个文件个格式根据程序的使用方式不同可能会有差异，但他们都以环境变量的方式进行传递。这是因为直接写在命令中会被<code>history</code>记录，那这个很容易被其他人看到。假如直接写在一个配置文件里，那这个配置文件的读写权限就被拉高了。可能会干扰到正常的执行程序。那最好的方法就显而易见了，<strong>我们使用<code>.env</code>这种文件来存放关键变量，并设置正确的权限</strong>让无关人员不会知道他们。</p>
<p>未完待续...</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>https://www.raspberrypi.com/software/    "树莓派官网"</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>https://en.wikipedia.org/wiki/Multicast_DNS    "mDNS的wiki"</p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>https://shumeipai.nxez.com/2013/10/15/raspberry-pi-and-a-network-cable-directly-connected-laptop.html    "网线连接树莓派发现ip"</p>
</div>
<div class="footnote-definition" id="4"><sup class="footnote-definition-label">4</sup>
<p>https://zhuanlan.zhihu.com/p/38853178    "串口连接树莓派"</p>
</div>
<div class="footnote-definition" id="5"><sup class="footnote-definition-label">5</sup>
<p>https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu-ports/    "清华ubuntu ports镜像"</p>
</div>
<div class="footnote-definition" id="6"><sup class="footnote-definition-label">6</sup>
<p>https://www.langzihan.top/2024/02/27/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/27.ubuntu%E5%BD%BB%E5%BA%95%E7%A7%BB%E9%99%A4snap/    "ubuntu 彻底移除 snap"</p>
</div>
<div class="footnote-definition" id="7"><sup class="footnote-definition-label">7</sup>
<p>https://cloud-atlas.readthedocs.io/zh-cn/latest/linux/redhat_linux/systemd/systemd_networkd_wlan.html    "使用systemd-networkd配置无线"</p>
</div>


        
    </article>

    <!-- Comment section -->
    
      
        
          <script
  src="https://giscus.app/client.js"
  data-repo="nan-mu&#x2F;nan-mu.github.io"
  data-repo-id="R_kgDOMkLDRQ"
  data-category="General"
  data-category-id="DIC_kwDOMkLDRc4CtsQb"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="preferred_color_scheme"
  data-lang="en"
  data-loading="lazy"
  crossorigin="anonymous"
  async
></script>

        
      
    


    <!-- Page footer -->
    
    <footer>
        <hr>
        <p>
            
                Published by 楠木
            
            
                
                in <a href="https://nan-mu.asia/categories/tutorial/">tutorial</a>
            
            
                and
                tagged
                
                    <a href="https://nan-mu.asia/tags/raspi/">raspi</a>
                    
                
            
        </p>
        
        
    </footer>


</article>


    </main>
    

  </body>
</html>
